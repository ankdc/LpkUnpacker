name: Build and Release CLI (Linux)

on:
  workflow_dispatch:  # Cho phép chạy thủ công

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        cache: 'pip'
    
    - name: Install system dependencies
      run: |
        echo "Installing Linux build dependencies..."
        sudo apt-get update
        sudo apt-get install -y patchelf gcc
        python --version
        pip --version
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install nuitka ordered-set zstandard

    - name: Cache Nuitka downloads
      uses: actions/cache@v4
      with:
        path: ~/.cache/Nuitka
        key: nuitka-cache-${{ runner.os }}-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          nuitka-cache-${{ runner.os }}-
    
    - name: Build executable with Nuitka
      run: |
        # Cấp quyền thực thi và chạy script biên dịch
        chmod +x compile.sh
        ./compile.sh
      
    - name: Verify build output
      run: |
        if [ ! -f "build/LpkUnpacker" ]; then
          echo "Build failed: LpkUnpacker binary not found"
          exit 1
        fi
        FILE_SIZE=$(du -h build/LpkUnpacker | cut -f1)
        echo "Build successful! File size: $FILE_SIZE"
    
    - name: Get version from tag
      id: get_version
      run: |
        echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
    
    - name: Prepare Release Notes
      id: release_notes
      run: |
        VERSION="${{ steps.get_version.outputs.VERSION }}"
        BUILD_DATE=$(date '+%Y-%m-%d %H:%M:%S')
        cat <<EOF > RELEASE_NOTES.md
        ## Release $VERSION (Linux CLI)
        
        **Build Date:** $BUILD_DATE
        **Platform:** Linux x64
        **Type:** CLI (Command Line Interface)
        
        ### Changes
        - Automated build for Linux CLI.
        EOF
    
    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        tag: ${{ steps.get_version.outputs.VERSION }}
        name: Release ${{ steps.get_version.outputs.VERSION }} (Linux CLI)
        bodyFile: RELEASE_NOTES.md
        artifacts: build/LpkUnpacker
        artifactContentType: application/octet-stream
        draft: true
        prerelease: false
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: |
          build/
          *.log
        retention-days: 7
